# TurtleBot 2 - ROS2 Humble on Jetson Nano

This project provides a complete ROS2 Humble setup for TurtleBot 2 running on NVIDIA Jetson Nano via Docker (standard Ubuntu 22.04, no GPU acceleration needed).

## Hardware

- **Compute**: NVIDIA Jetson Nano (4GB)
- **Mobile Base**: Kobuki (Yujin Robot)
- **Camera**: ASUS Xtion Pro (OpenNI2)
- **Previous**: Upgraded from NVIDIA TK1 + ROS1

## Cold Start Guide

Follow these steps to run the robot from a completely powered-off state.

### Step 1: Hardware Setup

1. Connect the Kobuki base to the Jetson Nano via USB (FTDI cable)
2. Connect the ASUS Xtion Pro camera to a USB port
3. Power on the Kobuki base (green LED should light up)
4. Power on the Jetson Nano

### Step 2: SSH into Jetson Nano

From your development machine:

```bash
ssh burf2000@jetson.local
# Or use the IP address: ssh burf2000@<jetson-ip>
```

### Step 3: Verify USB Devices

```bash
# Check Kobuki is detected (FTDI USB serial)
lsusb | grep -i "0403:6001"

# Check Xtion camera is detected
lsusb | grep -i "1d27:0601"

# Should see both devices
ls /dev/ttyUSB*  # Kobuki serial port
```

### Step 4: Launch the Robot

```bash
cd ~/turtlebot2

# Run the full robot stack (Kobuki + Xtion + TF + laser scan + point cloud)
./scripts/run.sh bringup
```

### Step 5: Verify Everything is Working

In a second SSH terminal:

```bash
# Enter the running container
docker exec -it $(docker ps -q) bash

# List all topics
ros2 topic list

# Check odometry is publishing
ros2 topic hz /odom

# Check camera is streaming
ros2 topic hz /camera/depth/image_raw

# Check laser scan (generated from depth camera)
ros2 topic hz /scan

# Check battery status
ros2 topic echo /sensors/battery_state --once

# Make the robot beep (confirms commands work)
ros2 topic pub --once /commands/sound kobuki_ros_interfaces/msg/Sound "{value: 0}"
```

## Quick Reference Commands

All commands use the helper script `./scripts/run.sh`:

```bash
# Interactive shell in container
./scripts/run.sh bash

# Launch full robot stack
./scripts/run.sh bringup

# Launch Kobuki base only
./scripts/run.sh kobuki

# Launch Xtion camera only
./scripts/run.sh camera

# Keyboard teleop
./scripts/run.sh teleop

# Desktop (RViz + teleop, run on desktop machine)
./scripts/run.sh desktop

# SLAM mapping
./scripts/run.sh slam

# Nav2 navigation
./scripts/run.sh nav

# Build Docker image
./scripts/run.sh build

# Development container (lighter weight)
./scripts/run.sh dev
```

## ROS2 Topics

### Kobuki Base Topics

| Topic | Type | Description |
|-------|------|-------------|
| `/odom` | nav_msgs/Odometry | Wheel odometry |
| `/cmd_vel` | geometry_msgs/Twist | Velocity commands |
| `/joint_states` | sensor_msgs/JointState | Wheel joint states |
| `/tf` | tf2_msgs/TFMessage | Transform tree |
| `/sensors/battery_state` | sensor_msgs/BatteryState | Battery voltage/percentage |
| `/imu` | sensor_msgs/Imu | IMU data |
| `/sensors/core` | kobuki_ros_interfaces/SensorState | Raw sensor data |
| `/events/bumper` | kobuki_ros_interfaces/BumperEvent | Bumper events |
| `/events/cliff` | kobuki_ros_interfaces/CliffEvent | Cliff sensor events |
| `/commands/sound` | kobuki_ros_interfaces/Sound | Play sounds (0-6) |
| `/commands/led1` | kobuki_ros_interfaces/Led | LED 1 control |
| `/commands/led2` | kobuki_ros_interfaces/Led | LED 2 control |

### Camera Topics

| Topic | Type | Description |
|-------|------|-------------|
| `/camera/depth/image_raw` | sensor_msgs/Image | Depth image (320x240 @ 30fps) |
| `/camera/depth/camera_info` | sensor_msgs/CameraInfo | Depth camera calibration |
| `/camera/rgb/image_raw` | sensor_msgs/Image | RGB image (320x240 @ 30fps) |
| `/camera/rgb/camera_info` | sensor_msgs/CameraInfo | RGB camera calibration |

### Derived Topics (generated by bringup launch)

| Topic | Type | Description |
|-------|------|-------------|
| `/scan` | sensor_msgs/LaserScan | Virtual laser scan from depth image (RELIABLE QoS) |
| `/camera/depth/points` | sensor_msgs/PointCloud2 | XYZRGB point cloud from depth + RGB |

## Launch Arguments

The main launch file supports these arguments:

```bash
ros2 launch turtlebot2_bringup turtlebot2.launch.py \
  launch_kobuki:=true \
  launch_camera:=true \
  launch_robot_state_publisher:=true \
  use_sim_time:=false
```

| Argument | Default | Description |
|----------|---------|-------------|
| `launch_kobuki` | true | Launch Kobuki base driver |
| `launch_camera` | true | Launch Xtion camera driver |
| `launch_robot_state_publisher` | true | Launch robot URDF publisher |
| `use_sim_time` | false | Use simulation time |

## Project Structure

```
turtlebot2/
├── scripts/
│   └── run.sh                     # Helper script for all commands
├── docker/
│   ├── Dockerfile                 # Full image with all dependencies
│   ├── Dockerfile.dev             # Lighter development image
│   └── ros_entrypoint.sh         # Container entrypoint
├── docker-compose.yml             # Main compose file
├── docker-compose.jetson.yml      # Jetson-specific overrides
├── src/
│   ├── turtlebot2_description/    # URDF and meshes
│   │   ├── urdf/
│   │   │   ├── turtlebot2.urdf.xacro
│   │   │   ├── kobuki.urdf.xacro
│   │   │   └── sensors/
│   │   │       └── xtion.urdf.xacro    # ASUS Xtion Pro
│   │   └── launch/
│   │       └── robot_state_publisher.launch.py
│   └── turtlebot2_bringup/       # Launch files and configs
│       ├── launch/
│       │   ├── turtlebot2.launch.py    # Full bringup
│       │   ├── kobuki.launch.py        # Kobuki base only
│       │   ├── astra.launch.py         # Camera only
│       │   ├── desktop.launch.py       # RViz + teleop (desktop)
│       │   ├── slam.launch.py          # SLAM Toolbox
│       │   └── nav2.launch.py          # Nav2 navigation
│       └── config/
│           ├── kobuki.yaml
│           ├── xtion.yaml
│           ├── slam_params.yaml
│           └── nav2_params.yaml
└── data/
    └── maps/                      # Saved maps
```

## Building the Docker Image

```bash
cd ~/turtlebot2

# Build using the helper script (auto-detects Jetson vs non-Jetson)
./scripts/run.sh build

# Or manually with docker-compose
docker-compose build
```

The Dockerfile uses `ros:humble-ros-base` (standard Ubuntu 22.04) as the base image. Kobuki and ECL packages are built from source; all other dependencies (openni2_camera, depthimage_to_laserscan, etc.) are installed as pre-built binaries via apt.

## Troubleshooting

### Xtion Audio Driver Conflict (Ubuntu 22.04)

On Ubuntu 22.04, the kernel's `snd-usb-audio` driver may claim the Xtion's USB audio interfaces, preventing OpenNI2 from accessing the depth camera. You'll see `Failed to set USB interface!` errors in the logs.

**Fix**: Unbind the audio interfaces before launching:

```bash
# Find the Xtion's USB path (look for 1d27:0601)
# Then unbind the audio interfaces (adjust path as needed)
sudo sh -c 'echo 1-2.4:1.1 > /sys/bus/usb/drivers/snd-usb-audio/unbind'
sudo sh -c 'echo 1-2.4:1.2 > /sys/bus/usb/drivers/snd-usb-audio/unbind'
```

For a permanent fix, install udev rules to auto-unbind on plug-in. See the udev rules at `/etc/udev/rules.d/90-xtion-unbind-audio.rules` on the Jetson.

### Kobuki Not Detected

```bash
# Check USB connection
lsusb | grep -i "FTDI"
# Should show: Future Technology Devices International

# Check device exists
ls -la /dev/ttyUSB*

# If permission denied:
sudo chmod 666 /dev/ttyUSB0
```

### Xtion Camera Issues

```bash
# Check USB connection
lsusb | grep -i "1d27"
# Should show: ASUS Xtion Pro

# Test camera detection inside container
ros2 run openni2_camera list_devices

# If "USB transfer timeout" errors occur, the standalone driver
# works better than ComposableNodeContainer (already configured)
```

### No /scan or Point Cloud Data

```bash
# Check the depth camera is publishing
ros2 topic hz /camera/depth/image_raw

# Check nodes are running
ros2 node list | grep depthimage_to_laserscan
ros2 node list | grep point_cloud

# Check QoS compatibility (important for RViz on remote machine)
ros2 topic info /scan --verbose
# /scan uses RELIABLE + TRANSIENT_LOCAL QoS
# RViz subscribers must match this or they won't receive data
```

### Container Can't Access USB Devices

The container must run privileged with `/dev` mounted. The `run.sh` script and docker-compose handle this automatically. If running manually:

```bash
docker run --rm -it --privileged -v /dev:/dev turtlebot2_humble bash
```

### Check Running Topics

```bash
# List all active topics
ros2 topic list

# Check publishing rate
ros2 topic hz /odom
ros2 topic hz /camera/depth/image_raw
ros2 topic hz /scan

# View topic data
ros2 topic echo /sensors/battery_state --once
```

### View Camera Images (from remote machine)

On a machine with ROS2 and a display:

```bash
# Make sure ROS_DOMAIN_ID matches
export ROS_DOMAIN_ID=0

# View depth image
ros2 run rqt_image_view rqt_image_view /camera/depth/image_raw

# View RGB image
ros2 run rqt_image_view rqt_image_view /camera/rgb/image_raw
```

## Dependencies

The Docker image includes:

- [kobuki-base/kobuki_ros](https://github.com/kobuki-base/kobuki_ros) - Kobuki ROS2 driver (built from source)
- [kobuki-base/kobuki_core](https://github.com/kobuki-base/kobuki_core) - Kobuki core library (built from source)
- [stonier/ecl_core](https://github.com/stonier/ecl_core) - ECL libraries (built from source)
- [ros-drivers/openni2_camera](https://github.com/ros-drivers/openni2_camera) - OpenNI2 camera driver (apt)
- [ros-humble-depthimage-to-laserscan](https://index.ros.org/p/depthimage_to_laserscan/) - Depth to laser scan converter (apt)
- [ros-humble-depth-image-proc](https://index.ros.org/p/depth_image_proc/) - Point cloud generation (apt)

## References

- [ROS2 Humble Documentation](https://docs.ros.org/en/humble/)
- [Kobuki Documentation](https://kobuki.readthedocs.io/)
- [OpenNI2 Camera](https://github.com/ros-drivers/openni2_camera)
